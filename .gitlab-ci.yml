stages:
  - build

build_test_image:
  stage: build
  script:
    - docker build -t docker.infra.cloveri.com/$CI_PROJECT_PATH:t`grep version package.json | grep -Po [0-9.]*` .
    - docker login https://docker.infra.cloveri.com -u $CI_REGISTRY_USER --password-stdin <<<$CI_JOB_TOKEN
    - docker push docker.infra.cloveri.com/$CI_PROJECT_PATH:t`grep version package.json | grep -Po [0-9.]*`
  after_script:
    - docker rmi docker.infra.cloveri.com/$CI_PROJECT_PATH:t`grep version package.json | grep -Po [0-9.]*`
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  tags: [docker]

build_prod_image:
  stage: build
  script:
    - docker build -t docker.infra.cloveri.com/$CI_PROJECT_PATH:latest .
    - docker image tag docker.infra.cloveri.com/$CI_PROJECT_PATH:latest docker.infra.cloveri.com/$CI_PROJECT_PATH:`grep version package.json | grep -Po [0-9.]*' package.json`
    - docker login https://docker.infra.cloveri.com -u $CI_REGISTRY_USER --password-stdin <<<$CI_JOB_TOKEN
    - docker push docker.infra.cloveri.com/$CI_PROJECT_PATH:latest
    - docker push docker.infra.cloveri.com/$CI_PROJECT_PATH:`grep version package.json | grep -Po [0-9.]*' package.json` .
  after_script:
    - docker rmi docker.infra.cloveri.com/$CI_PROJECT_PATH:latest
    - docker rmi docker.infra.cloveri.com/$CI_PROJECT_PATH:`grep version package.json | grep -Po [0-9.]*` .
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
  tags: [docker]
