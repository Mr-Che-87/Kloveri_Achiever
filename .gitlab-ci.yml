stages:
  - build
  - notification

build_test_image:
  stage: build
  script:
    - docker build -t docker.infra.cloveri.com/$CI_PROJECT_PATH:t`grep version package.json | grep -Po [0-9.]*` .
    - docker login https://docker.infra.cloveri.com -u $CI_REGISTRY_USER --password-stdin <<<$CI_JOB_TOKEN
    - docker push docker.infra.cloveri.com/$CI_PROJECT_PATH:t`grep version package.json | grep -Po [0-9.]*`
  after_script:
    - docker rmi docker.infra.cloveri.com/$CI_PROJECT_PATH:t`grep version package.json | grep -Po [0-9.]*`
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  tags: [docker]

build_prod_image:
  stage: build
  script:
    - docker build -t docker.infra.cloveri.com/$CI_PROJECT_PATH:latest .
    - docker image tag docker.infra.cloveri.com/$CI_PROJECT_PATH:latest docker.infra.cloveri.com/$CI_PROJECT_PATH:`grep version package.json | grep -Po [0-9.]*' package.json`
    - docker login https://docker.infra.cloveri.com -u $CI_REGISTRY_USER --password-stdin <<<$CI_JOB_TOKEN
    - docker push docker.infra.cloveri.com/$CI_PROJECT_PATH:latest
    - docker push docker.infra.cloveri.com/$CI_PROJECT_PATH:`grep version package.json | grep -Po [0-9.]*' package.json` .
  after_script:
    - docker rmi docker.infra.cloveri.com/$CI_PROJECT_PATH:latest
    - docker rmi docker.infra.cloveri.com/$CI_PROJECT_PATH:`grep version package.json | grep -Po [0-9.]*` .
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
  tags: [docker]


notification:
  stage: notification
  script:
    - 'curl -X POST -s -H "Content-Type:multipart/form-data" -F message_thread_id=16 -F chat_id=-1002069789671_16 -F text="Project $CI_PROJECT_TITLE commit in $CI_COMMIT_BRANCH branch. Comment in commit: $CI_COMMIT_MESSAGE. Author of commit: $GITLAB_USER_LOGIN. Status: $CI_JOB_STATUS. $CI_JOB_URL" "https://api.telegram.org/$POS_TOK:$PRE_TOK/sendMessage"'
  tags: [docker]
#2069387923